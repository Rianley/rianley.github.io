---
title: "Mysql优化与分析"
categories: php
tags:
 - 数据库
 - mysql
author: Rianley

---

##### 什么是Mysql的优化

* 设计角度：存储引擎的选择，字段类型选择，范式
* 利用mysql自身的特性：索引，查询缓存，分区分表，存储过程，sql语句优化配置，
* 部署大负载架构体系：主从复制，读写分离。
* 硬件升级

##### 怎么知道哪条sql需要优化
我们知道一般的应用系统，读写比例在10:1左右，而且插入操作和一般的更新操作很少出现性能问题，遇到最多的，也是最容易出问题的，还是一些复杂的查询操作，所以查询语句的优化显然是重中之重。  
所以，我们要优化语句，就先要知道哪条执行比较慢，具体来看下怎么做。

* 慢查询日志  
是一种mysql提供的日志，记录所有执行时间超过某个时间界限的sql的语句。这个时间界限，我们可以指定。在mysql中默认没有开启慢查询，即使开启了，只会记录执行的sql语句超过10秒的语句。  

1.打开mysql的配置文件，位置在 mysql/mys.ini,开启 log-slow-queries ="man-log" 与 long_query_time=0.5。慢查询的日志默认是保存在和数据库同一个文件夹里边的，当然也可以自定义路径，如“ log-slow-queries="D:/log-slow"；第二个选项是指定时间界限，表示sql语句执行超过该值，就把sql语句记录到慢查询日志里，单位是秒。
  
2.进行测试，打开慢查询日志文件进行查看。查看是否有记录执行时间超过时间界限的sql 语句。  

* 精确记录查询时间   

使用mysql提供的profile机制完成，profile记录每次执行sql语句的具体时间， 该时间精确到小数点后8位。

1.如何开启：set profiling=1|0  (开启或关闭)，注意：不需要分析时，最好将其关闭  

2.如何查看记录的sql语句的时间：show profiles;
一般情况，语句执行比较慢，原因是因为没有添加索引，或者索引设置不当等

##### 索引 
索引是一种，利用数据的某个特征（属性），快速定位该数据位置的技术。  
索引的作用：是用于快速定位实际数据位置的一种机制。
索引在mysql中，是独立于数据的一种特殊的数据结构，索引的存在类似于‘书里面的目录’，‘办公大楼里面的导航牌’。

* 索引的类型  
1.普通索引： 利用特定的关键字，标识数据记录的位置（磁盘上的位置，盘号，柱面，扇面，磁道）。 
2.唯一索引： 限制索引的关键字不能重复的索引。 
3.主键索引： 限制索引的关键字不能重复，并且不能为NULL。（不能为NULL的唯一索引）。一个表中只允许有一个主索引。 
4.全文索引： 索引的关键字，不是某个字段的值，而是字段值中有意义的词来作为关键字建立索引。
5.复合索引: 如果一个索引（以上四种任何都可以），是依赖于多个字段创建的化，称之为复合索引。

* 创建索引
1.建表时，与字段一并创建索引   

2.已有表格，使用 alter 语句。注：在添加索引时，如果没有指定索引的名称，则是把字段名称当成索引的名称的。

* 删除索引  
以alter语法的形式删除索引。  
注：  
主键索引，先删除自增的属性，然后再删除。alter table 表名 drop primary key;  
其他索引，alter table 表名  drop  index 索引的名

* 查看索引  
show indexes from table_name;   
show index from table_name   
show create table table_name
show keys from table_name  
desc table_name  

* 索引的结构
1.MYism引擎的索引的数据结构  
索引的节点中存储的是数据的物理地址（磁道和扇区）在查找数据时，查找到索引后，根据索引节点中的物理地址，查找到具体的数据内容。
注：在myisam引擎里面，数据是按照插入的顺序来插入的。  

2.innodb的索引的数据结构  
innodb的主键索引文件上 ，直接存放该行数据,称为聚簇索引。
注：
主键索引 既存储索引值,又在叶子中存储行的数据。  
如果没有主键, 则会Unique key做主键。  
如果没有unique,则系统生成一个内部的rowid做主键。   
在innodb里面，数据是按照主键的顺序插入数据的，根据innodb索引的结构，每插入一条数据，会重新排序。在大量插入数据时，会影响效率。  
像innodb中,主键的索引结构中,既存储了主键值,又存储了行数据,这种结构称为”聚簇索引” 。

* 如何更好的创建索引 
1.较频繁的作为查询条件字段应该创建索引  
  
2.唯一性太差的字段不适合单独创建索引，即使频繁作为查询条件  

3.更新非常频繁的字段不适合创建索引  
例：select * from emp where logincount = 1   
4.不会出现在WHERE子句中字段不该创建索   

##### 执行计划
用于分析sql语句的执行情况（并不执行sql语句）得到sql语句是否使用了索引，使用了哪些索引。  
语法：explain  sql语句\G   或 desc sql语句\G  
注：在mysql之前的版本中，explain只支持select语句，但是在最新的5.6版本中，它支持 explain update/delete了。

* type 查询的方式
all:扫描了所有的数据行

index：比all性能好点，扫描了所有的索引节点
注：  
1.索引覆盖的查询情况下，能利用上索引，但是又必须全索引扫描。
2.是利用索引来排序，但只能取出所以的列。

range:意思是查询时，能根据索引做范围扫描  

ref:是指，通过索引列，可以直接引用到某些数据行  

const,system,null这3个分别指查询优化到常量级别，甚至不需要查找时间。
一般按照主键来查询时，易出现 const,system 
或者直接查询某个表达式，不经过表时，出现null. 

* possible_key:可能用到的索引  
注意：系统估计可能用的几个索引，但最终，只能用1个。

* key:最终用的索引。 重点要看的数据
* key_len:使用的索引的最大长度。单位是字节 
* rows:当前的查询扫描的行数  
* extra: 
using index :是指用到了索引覆盖，效率非常高  
using where:是指光靠索引定位不了，还得where判断一下  
using temporary:是指用上了临时表，group by 与order by不同列时，或group by,order by 别的表的列  
using filesort:文件排序（文件可能在磁盘，也可能在内存）

##### 索引的使用细节 
* 全职匹配  
条件字段使用“=“ ，条件字段必须建立索引，才能用到
* 范围匹配（<= >= between and）
* 左值匹配（like条件中左边有值） 
在mysql中，以%开头的like查询用不到索引，只以%结尾的可以。
* 独立的列  
索引列不能是表达式的一部分，也不能是函数的参数。如(错误) where id+1=2;（正确）where 1+1=id;
* or运算都有索引  
如果出现OR(或者)运算，要求所有参与运算的字段都存在索引，才会使用到索引
* 多列索引（复合索引、联合索引）
对于创建的多列(复合)索引，只要查询条件使用了最左边的列，索引一般就会被使用。因为联合索引是需要按顺序执行的，比如c1234联合索引，要想在c2上使用索引，必须先在c1上使用索引，要想在c3上使用索引，必须先在c2上使用索引，依此类推。
* 当取出的数据量超过表中数据的20%，优化器就不会使用索引，而是全表扫描

##### 索引覆盖  
如果查询的列恰好是索引的一部分，那么查询只需要在索引文件上进行，不需要回行到磁盘再找数据，这种查询速度非常快，称为“索引覆盖”。


##### 调整mysql内部配置
　　（1）、改变索引缓冲区长度（key_buffer）；
　　推荐设置整个系统内存的25%.
　　（2）、改变表长（read_buffer_size）
　　当数据库对某个表进行频繁的扫描的时候，mysql会分配一段内存缓冲区，如果觉得扫描进行的太慢，可以适当将该值大小。
　　（3）、设定打开表的数目的大小（table_cache）
　　该变量控制mysql在任何时候打开表的最大数目，由此来控制服务器响应输入请求的能力。他跟max_connections
　　（4）、对缓查询设定一个时间限制（long_query_time）
　　ySQL带有"慢查询日志",它会自动地记录所有的在一个特定的时间范围内尚未结束的查询。这个日志对于跟踪那些低效率或者行为不端的查询以及寻找优化对象都非常有用。long_query_time变量控制这一最大时间限定，以秒为单位。也可设置为ms,但是需要打补丁。

参考资料：  
* [MySQL性能优化的最佳20+条经验](http://coolshell.cn/articles/1846.html){:target="_blank"}
* [mysql处理海量数据时的一些优化查询速度方法](https://goo.gl/1lOmi8/){:target="_blank"}
* [MySQL索引原理及慢查询优化](http://tech.meituan.com/mysql-index.html){:target="_blank"}
